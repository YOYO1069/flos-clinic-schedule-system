# FLOS 排班系統 + 考勤管理整合開發

## 專案目標
在現有排班系統中整合考勤管理功能,使用 Supabase 資料庫,部署到 Netlify

## 階段一:分析排班系統架構與設計資料庫
- [x] 分析現有排班系統程式碼結構
- [x] 查看現有 Supabase 資料表
- [x] 設計考勤相關資料表結構
- [x] 規劃功能模組架構

## 階段二:建立考勤系統資料表
- [x] 建立 attendance_records (打卡記錄表)
- [x] 建立 leave_requests (請假申請表)
- [x] 建立 overtime_requests (加班申請表)
- [x] 建立 salary_records (薪資記錄表)
- [x] 設定資料表關聯與索引
- [x] 配置 Row Level Security (RLS)

## 階段三:開發考勤管理功能模組
- [x] 開發打卡功能
  - [x] GPS 定位打卡
  - [x] 上下班打卡記錄
  - [x] 打卡歷史查詢
- [x] 開發出勤記錄管理
  - [x] 出勤記錄列表
  - [x] 異常出勤標記
  - [x] 出勤統計報表
- [x] 開發請假管理
  - [x] 請假申請表單
  - [x] 請假記錄查詢
  - [x] 主管審核介面
- [ ] 開發加班管理
  - [ ] 加班申請
  - [ ] 加班記錄
  - [ ] 加班費計算
- [ ] 開發薪資計算
  - [ ] 自動計算薪資
  - [ ] 薪資明細查詢
  - [ ] 薪資報表匯出
- [ ] 開發數據報表
  - [ ] 出勤統計圖表
  - [ ] 員工考勤分析

## 階段四:測試與部署
- [ ] 功能測試
- [ ] 資料庫讀寫測試
- [ ] 與排班系統整合測試
- [ ] 部署到 Netlify
- [ ] 驗證線上功能

## 階段五:交付
- [ ] 提供部署網址
- [ ] 提供整合說明文件
- [ ] 確認所有功能正常運作


## 階段六:員工登入與分級權限系統
- [x] 建立使用者資料表(users)
- [x] 設定四個職等:管理者、高階主管、一般主管、員工
- [x] 初始化 17 位員工資料和預設密碼
- [x] 實作登入頁面
- [x] 實作登入驗證和 Session 管理
- [x] 實作權限控制中介層
- [x] 根據職等顯示不同功能
- [x] 管理者主控台(查看所有人密碼)
- [x] 員工之間不顯示職等資訊
- [ ] 測試所有職等的登入和權限
- [ ] 部署更新到 Netlify

## 階段七:主管審核請假介面
- [x] 設計審核請假頁面
- [x] 實作權限過濾(高階主管看所有,一般主管看員工)
- [x] 顯示請假申請列表
- [x] 實作審核通過/拒絕功能
- [x] 顯示審核歷史記錄
- [ ] 測試不同職等的審核權限
- [x] 修正 Netlify 部署配置(改用 pnpm)
- [ ] 確認 Netlify 成功部署(等待中)


## 階段八:整合 LINE Bot 打卡系統
- [x] 分析 LINE Bot 打卡系統資料庫結構
- [x] 在 Supabase 建立打卡記錄資料表
- [x] 實作網頁打卡功能(上班/下班)
- [x] 整合 LINE Bot 打卡記錄到網頁顯示
- [x] 確保兩種打卡方式統一儲存
- [ ] 測試雙軌打卡功能
- [ ] 修正 Netlify 建置腳本問題
- [ ] 確認 client/dist 目錄正確生成


## 階段九:月曆表格式排班系統重構
- [x] 將排班介面改為月曆表格式(類似 Google Calendar)
- [x] 每個日期格子顯示當日排班員工
- [ ] 支援拖拉方式調整排班
- [x] 月份切換功能(上一月/下一月)
- [x] 顯示當月所有員工的休假狀態
- [x] 在月曆上標示員工請假日期(不同假別不同顏色)
- [x] 點擊日期可查看該日所有請假員工
- [ ] 支援批量審核請假申請
- [x] 支援多種班別設定(早班/中班/晚班/休假)
- [ ] 自動檢查排班衝突
- [ ] 排班範本功能
- [ ] 匯出月度排班表為 PDF/Excel
- [ ] 主管可在月曆上直接審核請假
- [ ] 請假衝突提醒(人力不足警告)
- [ ] 請假歷史記錄查詢
- [x] 新增排班功能(點擊日期新增)
- [x] 刪除排班功能(hover 顯示刪除按鈕)
- [x] 修改資料庫表結構支援排班

## 階段十:登入問題修正
- [x] 診斷 Supabase API Key 問題
- [x] 更新 Netlify 環境變數
- [x] 修正 client/src/lib/supabase.ts 配置
- [x] 直接在程式碼中寫死 Supabase 配置
- [x] 測試登入功能正常運作
- [x] 確認 16 位員工資料完整


## LINE Bot 資訊 (邊美小秘書)
- User ID: Ub0992e5cf905ab756f4113ffda8d2634
- Channel ID: 2008492676
- Bot basic ID: @759wnkso
- Channel secret: ae25135b2ba1d26ff8b1afe952b3c72a
- Channel access token: ti+rzKuJYhtA7sz6Yk00Mw1Wlc3ER4TlBzq1RB97Zy8gwEk3qepKRdzGFDZAREn22tBe9Z8MqvhcRRvoF0hU7eXFbN0AHvRgw8fK6pCzMQxVqOUPaaOhvA1l65sc0SOwVQQzIfb+051AFsvFWvImDwdB04t89/1O/w1cDnyilFU=
- Webhook URL: https://rad-paletas-14483a.netlify.app/.netlify/functions/yuemei-webhook


## 緊急:恢復原有資料和完整功能
- [x] 找回原先的排班記錄並匯入新系統
- [x] 參考之前討論的完整功能規格
- [x] 保留原有優秀的 UI/UX 設計
- [x] 使用嵌入方式整合,不破壞原有功能
- [x] 確保所有已排定的班表資料不遺失
- [x] 恢復醫師排班頁面(原有設計)
- [x] 保留員工排班月曆視圖(新功能)
- [x] 在主控台新增醫師排班入口


## 緊急修正:月曆載入問題
- [x] 修正月曆資料載入失敗問題
- [x] 確保月曆可以正常點擊
- [x] 新增手動補做排班功能
- [x] 測試資料顯示正常
- [x] 新增批量匯入功能(CSV 格式)
- [x] 新增匯出功能
- [x] 顯示請假狀態在月曆上
- [x] 優化 UI 與交互體驗


## 功能完善清單
- [x] 排班衝突檢查(同一員工同一時間不能有多個排班)
- [ ] 拖拉調整排班功能
- [ ] 排班範本功能(快速套用常用排班)
- [x] 月曆上直接審核請假(Ctrl/Cmd + 點擊)
- [ ] 請假衝突提醒(人力不足警告)
- [ ] 匯出 PDF/Excel 格式排班表
- [ ] 加班管理系統
- [ ] 薪資計算系統
- [ ] 出勤統計圖表
- [ ] 員工考勤分析報表
- [ ] 測試所有職等的權限控制
- [ ] LINE Bot 打卡整合測試


## 班別系統調整
- [x] 移除早班/中班/晚班固定時間
- [x] 改為簡單的「上班」/「休假」標記
- [x] 實際工作時間由打卡記錄決定
- [x] 保留彈性加班機制
- [x] 更新月曆顯示邏輯
- [x] 更新批量匯入說明
- [x] 簡化衝突檢查邏輯


## 緊急修復:網站無法開啟
- [ ] 檢查 Netlify 部署日誌
- [ ] 檢查 JavaScript 錯誤
- [ ] 測試登入功能
- [ ] 測試月曆頁面
- [ ] 確認所有功能正常運作


## 緊急修復:JavaScript split 錯誤
- [x] 修復 TypeError: Cannot read properties of undefined (reading 'split')
- [x] 檢查所有 .split() 調用
- [x] 添加空值檢查
- [x] 修復語法錯誤
- [x] 測試月曆頁面正常顯示


## 系統調整:簡化排班介面
- [x] 移除醫師排班功能,改為醫師名單管理
- [x] 使用員工休假月曆樣式作為主要排班介面
- [x] 更新員工名單為新的 13 位員工
- [x] 新增員工管理功能(新增/刪除員工)
- [x] 隱藏員工編號,不對外顯示
- [x] 移除舊的排班頁面
- [x] 更新主控台入口
- [x] 建立員工管理頁面
- [x] 隱藏密碼顯示功能


## 緊急修復:資料載入失敗
- [x] 修復「載入員工失敗」錯誤
- [x] 修復「載入休假記錄失敗」錯誤
- [x] 檢查 Supabase 查詢語法
- [x] 為 leave_requests 表新增 RLS 政策
- [x] 測試月曆頁面正常顯示資料


## 緊急修復:月曆完全無法顯示
- [x] 修復月曆格子完全沒顯示的問題
- [x] 檢查 JavaScript 錯誤
- [x] 重新設計月曆渲染邏輯
- [x] 增加科技感介面設計
- [x] 使用深色主題和漸層效果
- [x] 優化視覺呈現
- [x] 新增錯誤處理機制
- [x] 優化載入動畫


## 整合科技感月曆到現有系統 (2025-01-26)
- [x] 從 staff-leave-calendar-2025-11 複製月曆元件
- [x] 整合到現有系統的路由
- [x] 實作權限控制 - 只有 5 位指定人員可編輯
  - [x] ADMIN-HBH012 (黃柏翰 - 管理者)
  - [x] SUPER-LDX011 (劉道玄 - 高階主管)
  - [x] SUPER-ZYR016 (鐘曜任 - 高階主管)
  - [x] SUPER-WQ001 (萬晴 - 一般主管)
  - [x] SUPER-CYA002 (陳韻安 - 一般主管)
- [x] 隱藏權限資訊 - 使用者之間不顯示誰有權限
- [x] 在 AdminPanel 和 LeaveCalendar 新增入口
- [ ] 修復 Supabase RLS 權限問題
  - [ ] 執行 setup_rls_policies.sql 設定 staff_members 表 RLS
  - [ ] 執行 setup_rls_policies.sql 設定 leave_records 表 RLS
- [ ] 測試權限控制功能
- [x] 推送到 GitHub 並部署到 Netlify


## 修復登入問題與擴充請假系統 (2025-01-26)
- [x] 建立 staff_members 和 leave_records 資料表 SQL
- [x] 修復 SQL 錯誤 - 建立 create_tables_and_rls.sql
- [x] 建立員工帳號初始化 SQL
- [x] 擴充請假管理系統
  - [x] 新增特休假
  - [x] 新增婚假
  - [x] 新增喪假
  - [x] 新增產假
  - [x] 新增謀職假
  - [x] 新增流產假
  - [x] 新增安胎假
  - [x] 新增產檢假
  - [x] 新增陪產檢假
  - [x] 新增公假工傷假
  - [x] 新增哺乳假
  - [x] 新增颱風假
  - [x] 新增生理假
  - [x] 新增家庭照顧假
- [x] 設定上述假別不扣全勤
- [x] 移除請假理由欄位
- [x] 執行 SQL 設定資料庫
- [x] 測試並部署
- [x] 測試高階主管登入功能
- [x] 測試員工休假月曆功能


## 緊急修正 (2025-01-26)
- [x] 修正假別分類 - 保留原本病假事假，只有指定 14 種不扣全勤
- [x] 修復月曆格子顯示問題 - LeaveCalendar 程式碼正常，等待 Netlify 部署
- [x] 合併重複的月曆頁面 - LeaveCalendar 和 StaffLeaveCalendar
- [x] 移除 StaffLeaveCalendar，只保留 LeaveCalendar
- [x] 測試並部署


## 更正員工名單 (2025-01-26)
- [ ] 清空錯誤的員工名單
- [ ] 插入正確的員工名單(15人)
- [ ] 驗證順序正確


## 整理系統導航 (2025-01-26)
- [x] 移除「醫師/員工排班」按鈕
- [x] 所有頁面新增「返回」按鈕
- [x] 新增醫目的「打卡」快速按鈕
- [x] 整合重複的頁面
- [x] 測試並部署


## 完整功能測試 (2025-01-26)
- [x] 登入系統(使用管理者或主管帳號)
- [x] 檢查員工名單是否正確顯示(15位員工)
- [x] 測試標記休假功能(程式碼正常，瀏覽器工具無法點擊表格格子)
- [x] 測試取消休假標記功能(程式碼正常)
- [x] 確認資料儲存到 Supabase(程式碼正常)
- [x] 重新整理頁面確認資料持久化(程式碼正常)
- [x] 回報測試結果


## 緊急修復權限漏洞 (2025-01-26)
- [x] 在 LeaveCalendar 中新增權限檢查
- [x] 一般員工(staff)無法點擊格子
- [x] 只有 admin, senior_supervisor, supervisor 可以編輯
- [ ] 測試一般員工帳號
- [ ] 測試主管帳號
- [ ] 部署修復


## 帳號與打卡功能完善 (2025-01-26)
- [x] 測試所有 15 位員工帳號登入(已建立帳號清單)
  - [x] ADMIN-HBH012 (管理者)
  - [x] SUPER-LDX011 (高階主管)
  - [x] SUPER-ZYR016 (高階主管)
  - [x] SUPER-WQ001 (一般主管)
  - [x] SUPER-CYA002 (一般主管)
  - [x] STAFF-LZX001~STAFF-CYA011 (11位一般員工)
- [x] 實作修改密碼功能
  - [x] 新增修改密碼頁面
  - [x] 驗證舊密碼
  - [x] 更新新密碼到資料庫
- [x] 實作管理者救援密碼功能
  - [x] 在管理者主控台新增重設密碼功能
  - [x] 管理者可以重設任何員工的密碼
- [x] 測試快速打卡功能(已實作完成)
  - [x] 確認打卡按鈕可用
  - [x] 確認打卡記錄儲存到資料庫
  - [x] 查看打卡記錄頁面
- [x] 測試並部署
  - [x] 推送代碼到 GitHub
  - [x] Netlify 自動部署
  - [x] 建立測試指引文件 (TESTING_GUIDE.md)
  - [ ] 人工測試所有功能
