# FLOS 排班系統 + 考勤管理整合開發

## 專案目標
在現有排班系統中整合考勤管理功能,使用 Supabase 資料庫,部署到 Netlify

## 階段一:分析排班系統架構與設計資料庫
- [x] 分析現有排班系統程式碼結構
- [x] 查看現有 Supabase 資料表
- [x] 設計考勤相關資料表結構
- [x] 規劃功能模組架構

## 階段二:建立考勤系統資料表
- [x] 建立 attendance_records (打卡記錄表)
- [x] 建立 leave_requests (請假申請表)
- [x] 建立 overtime_requests (加班申請表)
- [x] 建立 salary_records (薪資記錄表)
- [x] 設定資料表關聯與索引
- [x] 配置 Row Level Security (RLS)

## 階段三:開發考勤管理功能模組
- [x] 開發打卡功能
  - [x] GPS 定位打卡
  - [x] 上下班打卡記錄
  - [x] 打卡歷史查詢
- [x] 開發出勤記錄管理
  - [x] 出勤記錄列表
  - [x] 異常出勤標記
  - [x] 出勤統計報表
- [x] 開發請假管理
  - [x] 請假申請表單
  - [x] 請假記錄查詢
  - [x] 主管審核介面
- [ ] 開發加班管理
  - [ ] 加班申請
  - [ ] 加班記錄
  - [ ] 加班費計算
- [ ] 開發薪資計算
  - [ ] 自動計算薪資
  - [ ] 薪資明細查詢
  - [ ] 薪資報表匯出
- [ ] 開發數據報表
  - [ ] 出勤統計圖表
  - [ ] 員工考勤分析

## 階段四:測試與部署
- [ ] 功能測試
- [ ] 資料庫讀寫測試
- [ ] 與排班系統整合測試
- [ ] 部署到 Netlify
- [ ] 驗證線上功能

## 階段五:交付
- [ ] 提供部署網址
- [ ] 提供整合說明文件
- [ ] 確認所有功能正常運作


## 階段六:員工登入與分級權限系統
- [x] 建立使用者資料表(users)
- [x] 設定四個職等:管理者、高階主管、一般主管、員工
- [x] 初始化 17 位員工資料和預設密碼
- [x] 實作登入頁面
- [x] 實作登入驗證和 Session 管理
- [x] 實作權限控制中介層
- [x] 根據職等顯示不同功能
- [x] 管理者主控台(查看所有人密碼)
- [x] 員工之間不顯示職等資訊
- [ ] 測試所有職等的登入和權限
- [ ] 部署更新到 Netlify

## 階段七:主管審核請假介面
- [x] 設計審核請假頁面
- [x] 實作權限過濾(高階主管看所有,一般主管看員工)
- [x] 顯示請假申請列表
- [x] 實作審核通過/拒絕功能
- [x] 顯示審核歷史記錄
- [ ] 測試不同職等的審核權限
- [x] 修正 Netlify 部署配置(改用 pnpm)
- [ ] 確認 Netlify 成功部署(等待中)


## 階段八:整合 LINE Bot 打卡系統
- [x] 分析 LINE Bot 打卡系統資料庫結構
- [x] 在 Supabase 建立打卡記錄資料表
- [x] 實作網頁打卡功能(上班/下班)
- [x] 整合 LINE Bot 打卡記錄到網頁顯示
- [x] 確保兩種打卡方式統一儲存
- [ ] 測試雙軌打卡功能
- [x] 修正 Netlify 建置腳本問題
- [x] 確認 client/dist 目錄正確生成
- [x] 修正登入驗證失敗問題
- [x] 檢查 Supabase 環境變數配置
- [x] 確認資料庫連線正常
- [ ] 調整員工名單使用排班系統的人員管理名單
- [ ] 保持現有職等分級不變

## 階段九:修復醫師排班匯出圖片功能
- [x] 解決 html2canvas 不支援 OKLCH 顏色格式問題
- [x] 改用 dom-to-image-more 替代方案
- [x] 測試圖片匯出功能
- [x] 部署修復到 Netlify

## 階段十:員工休假月曆 - 編輯員工功能
- [ ] 刪除測試員工「米米」 (用戶可在網站上直接刪除)
- [x] 實作編輯員工對話框
- [x] 實作編輯員工姓名功能
- [x] 實作調整員工順序功能
- [x] 測試編輯功能
- [x] 部署到 Netlify

## 階段十一:員工休假月曆進階功能
- [x] 設計並建立操作記錄資料表 (operation_logs)
- [x] 實作員工排序功能 (上下調整順序)
- [x] 實作普通員工權限控制 (只能點自己的排班)
- [x] 實作操作記錄功能 (記錄誰操作了什麼)
- [x] 新增 ON 符號選項
- [x] 新增「特」(特休)符號選項
- [ ] 管理員可查看操作記錄 (待實作查詢介面)
- [x] 測試所有功能
- [x] 部署到 Netlify
- [x] 新增員工職位欄位和資料
- [x] 職位顯示在管理員工對話框中

## 階段十二:員工打卡定位功能
- [x] 檢查網站所有現有功能
- [x] 設計打卡定位資料表結構
- [x] 實作打卡頁面和定位功能
- [x] 記錄打卡時間和GPS座標
- [x] 在打卡記錄中顯示GPS座標
- [x] 測試定位功能
- [x] 部署到 Netlify

## 階段十三:有效打卡範圍驗證功能
- [ ] 建立 clinic_locations 資料表(診所位置和有效範圍)
- [ ] 實作 Haversine 距離計算公式
- [ ] 在打卡時驗證是否在有效範圍內
- [ ] 顯示當前距離診所的距離
- [ ] 範圍外打卡標記為「待審核」
- [ ] 實作管理員設定診所位置介面
- [ ] 實作管理員設定有效範圍介面
- [ ] 實作管理員審核範圍外打卡
- [ ] 測試距離計算準確性
- [ ] 部署到 Netlify

## 階段十四:修復 iPhone 打卡問題
- [x] 診斷 iPhone 無法打卡的原因
- [x] 檢查 iOS Safari 定位 API 相容性
- [x] 修復定位權限請求問題
- [x] 讓定位失敗時也能正常打卡
- [x] 移除定位失敗的錯誤提示
- [x] 修正資料表欄位名稱 (attendance_date → work_date)
- [x] 測試 iPhone Safari 打卡功能
- [x] 部署修復

## 階段十五:LINE Bot 打卡功能 + 有效範圍驗證
- [ ] 設計 LINE Bot 打卡流程
- [ ] 設計有效打卡範圍驗證架構
- [ ] 建立 LINE Bot 帳號和 Channel
- [ ] 設定 Webhook URL
- [ ] 實作位置訊息接收功能
- [ ] 實作 Haversine 距離計算
- [ ] 實作範圍驗證邏輯
- [ ] 實作員工繫定功能(LINE ID ↔ 員工編號)
- [ ] 實作上班打卡指令(含位置驗證)
- [ ] 實作下班打卡指令(含位置驗證)
- [ ] 實作管理員審核範圍外打卡
- [ ] 實作查詢今日打卡狀態
- [ ] 實作推播提醒功能
- [ ] 測試 LINE Bot 打卡
- [ ] 部署到正式環境

## 階段十六:完整使用者權限系統
- [ ] 設計四級權限架構 (admin/senior_supervisor/supervisor/staff)
- [ ] 建立所有使用者帳號 (16位)
- [ ] 實作權限控制中介層
- [ ] 實作頁面權限檢查
- [ ] 實作功能權限檢查
- [ ] 測試管理員權限
- [ ] 測試高階主管權限
- [ ] 測試一般主管權限
- [ ] 測試員工權限
- [ ] 部署權限系統

## 階段十七:員工休假月曆 - 職稱編輯功能
- [x] 在編輯員工對話框中新增職稱欄位
- [x] 實作職稱編輯功能
- [x] 在員工列表中顯示職稱
- [x] 在月曆表格中顯示職稱
- [x] 測試職稱編輯功能
- [x] 部署功能

## 階段十八:新增12月新人帳號
- [x] 確認威廉的職位
- [x] 新增姜凱翔帳號（護理師）
- [x] 新增曾鈺晶帳號（美容師）
- [x] 新增何謙帳號（美容師）
- [x] 新增陳億燦帳號（美容師）
- [x] 新增威廉帳號（美容師）
- [x] 更新 staff_members 表
- [x] 驗證所有新帳號可以登入

## 階段十九:實作歷史打卡明細功能
- [x] 設計歷史打卡明細UI
- [x] 實作打卡記錄查詢功能
- [x] 實作日期範圍篩選
- [x] 實作打卡記錄匯出CSV功能
- [x] 測試歷史打卡明細功能

## 階段二十:實作自身操作費用計算功能
- [x] 訪問操作費計算機網站了解規則
- [x] 分析操作費計算邏輯
- [x] 建立操作費資料表SQL腳本
- [x] 設計操作費計算UI
- [x] 實作操作費計算功能
- [x] 實作操作費記錄查詢
- [x] 實作每月統計功能
- [x] 整合到系統（首頁新增按鈕）
- [ ] 在Supabase建立operation_fee_records資料表
- [ ] 測試操作費計算功能

## 階段二十一：改進打卡系統 - 多種打卡方式
- [x] 建立打卡設定資料表SQL腳本 (attendance_settings)
- [x] 保留原有的 GPS 打卡功能
- [x] 新增「手動輸入地點」選項
- [x] 新增「快速打卡」按鈕（無需定位）
- [x] 新增打卡方式選擇UI
- [ ] 在Supabase建立attendance_settings資料表
- [x] 實作管理員設定介面
- [x] 管理員可設定是否強制定位
- [x] 管理員可設定允許的打卡方式
- [x] 管理員可設定診所位置和有效距離
- [ ] 測試各種打卡方式
- [ ] 部署更新

## 階段二十二：修復帳號登入問題
- [x] 查詢 ADMIN-HBH012 帳號資訊
- [x] 檢查所有管理員帳號狀態
- [x] 檢查員工帳號密碼
- [x] 更新管理員密碼為Admin@HBH2025
- [x] 修正STAFF-XHY007姓名
- [x] 新增測試帳號STAFF-MM009（小鐘鐘）
- [x] 刪除15個舊帳號（BEAUTY和NURSE）
- [x] 測試登入功能

## 階段二十三：整合藍牙打卡功能
- [x] 解壓縮藍牙打卡程式碼
- [x] 分析藍牙打卡系統架構
- [x] 分析藍牙打卡功能實作
- [x] 設計整合方案（方案一）
- [x] 建立藍牙打卡資料表SQL腳本
- [x] 在Supabase執行SQL腳本
- [x] 在打卡頁面新增藍牙打卡選項
- [x] 實作藍牙裝置管理功能
- [x] 整合到現有打卡頁面
- [x] 更新上班打卡功能支援藍牙
- [x] 更新下班打卡功能支援藍牙
- [x] 測試藍牙打卡功能
- [x] 確保不影響現有功能
- [x] 部署更新

## 階段二十四：修復打卡功能失敗問題
- [ ] 檢查瀏覽器控制台錯誤訊息
- [ ] 檢查 Supabase 資料表結構
- [ ] 檢查打卡程式碼邏輯
- [ ] 修復打卡失敗問題
- [ ] 測試所有打卡方式
- [ ] 部署修復

## 階段二十五：緊急實作電子看板功能
- [x] 建立電子看板頁面
- [x] 顯示今日所有員工打卡狀況
- [x] 即時更新打卡狀態（30秒自動刷新）
- [x] 美化電子看板 UI
- [x] 新增到首頁導航
- [ ] 測試打卡功能
- [ ] 測試電子看板功能
- [ ] 部署更新

## 階段二十六：緊急修復打卡和電子看板問題
- [x] 診斷打卡失敗原因（source欄位不存在）
- [x] 檢查資料庫欄位
- [x] 修復打卡程式碼（移除source欄位）
- [x] 修復電子看板404問題（等待Netlify部署）
- [x] 立即部署
- [ ] 測試所有打卡方式
- [ ] 測試電子看板

## 階段二十七：簡化打卡方式
- [x] 移除「手動輸入地點」打卡方式
- [x] 移除快速打卡的所有限制
- [x] 保留 GPS 打卡和藍牙打卡供測試
- [ ] 測試快速打卡功能
- [ ] 部署更新

## 階段二十八:修復 Netlify 部署失敗
- [x] 修復 AttendanceDashboard.tsx 的 useNavigate 問題
- [x] 測試本地編譯
- [x] 推送修復並確認部署成功

## 階段二十九:重新設計入口導航結構
- [x] 參考藍牙打卡系統的卡片設計
- [x] 設計員工入口頁面(一般員工)
- [x] 設計主管入口頁面(一般主管)
- [x] 設計高階主管入口頁面
- [x] 設計管理員入口頁面
- [x] 移除不適合的功能(醫師排班、員工排班)
- [x] 新增適合的功能卡片
- [x] 測試並部署到 Netlify
- [x] 確認新首頁正常顯示

## 階段三十:修復休假月曆與恢復排班系統入口
- [x] 修復休假月曆日期顯示問題（顯示當前月份12月）
- [x] 恢復舊的醫師排班/員工排班入口頁面
- [x] 在首頁新增「排班系統」卡片連結
- [x] 測試所有功能
- [x] 部署到 Netlify
- [x] 提供網址給使用者

## 階段三十一:修復員工管理404與實作排班權限控制
- [x] 修復員工管理頁面404問題
- [x] 檢查 App.tsx 路由配置
- [x] 建立或修正 EmployeeManagement 頁面
- [x] 實作排班表權限控制（一般員工只能查看）
- [x] 醫師排班表：一般員工只能查看，主管以上可操作
- [x] 員工休假月曆：一般員工只能查看，主管以上可操作
- [x] 測試不同職等的權限
- [x] 部署到 Netlify

## 階段三十二:完成醫師排班表匯出功能
- [x] 實作匯出 Excel 功能
- [x] 實作匯出 PDF 功能
- [x] 測試匯出功能
- [x] 部署到 Netlify

## 階段三十三:移除匯出 Excel 和 PDF 按鈕
- [x] 移除 DoctorSchedule.tsx 中的 useSchedule 相關程式碼
- [x] 移除 Toolbar 中的 Excel 和 PDF 按鈕
- [x] 測試匯出圖片功能
- [x] 部署到 Netlify

## 階段三十四:修復權限和路由問題
- [x] 修復排班系統的電子看板權限問題（一般員工不能進入）
- [x] 修復打卡記錄頁面404問題
- [x] 部署到 Netlify

## 階段三十五:新增功能按鈕
- [x] 在請假審核頁面加入刪除按鈕
- [x] 在首頁加入快速打卡按鈕
- [x] 在首頁右上角加入修改密碼按鈕
- [x] 測試所有功能
- [x] 部署到 Netlify

## 階段三十六:更新12月醫師排班資料
- [x] 準倇12月排班資料（CSV格式）
- [x] 清空舊有12月排班資料
- [x] 匯入新的12月排班資料到 Supabase
- [x] 驗證資料是否正確顯示
- [x] 確認排班表正常運作

## 階段三十七:修正12月排班資料錯誤
- [x] 檢查目前排班資料與原始資料的差異
- [x] 更新前端 doctors 陣列
- [x] 修改 ScheduleContext 使用 doctor_id
- [x] 測試並部署更新
- [x] 確認網站顯示正確

## 階段三十八:修正所有打卡時間顯示為台灣時間
- [x] 檢查所有打卡相關頁面的時間顯示
- [x] 建立台灣時區轉換工具函數 (timezone.ts)
- [x] 修正打卡頁面時間顯示 (Attendance.tsx)
- [x] 修正電子看板時間顯示 (AttendanceDashboard.tsx)
- [x] 確保資料庫儲存 UTC 時間，前端顯示台灣時間
- [x] 測試編譯成功
- [ ] 部署到 Netlify
